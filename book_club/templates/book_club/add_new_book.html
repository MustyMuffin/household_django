{% extends "household_main/base.html" %}
{% load static %}

{% block content %}
  <h2>Add a New Book</h2>

  {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
  {% endif %}

  <!-- 1: Search -->
  <form id="search-form" class="mb-4">
    <label for="book-title-search">Search Book Title:</label>
    <input type="text" id="book-title-search" class="form-control" placeholder="e.g. Project Hail Mary" required>
    <button type="submit" class="btn btn-primary mt-2">Search</button>
  </form>

  <div id="search-error" class="alert alert-warning" style="display: none;"></div>

  <!-- 2: Confirm & Submit -->
  <form id="add-book-form" method="post" action="{% url 'book_club:add_new_book' %}" style="display: {% if prefill %}block{% else %}none{% endif %};">
    {% csrf_token %}
    <input type="hidden" name="source" id="book-source" value="{{ prefill.source|default:'' }}">

    <label for="title">Title</label>
    <input type="text" name="title" id="book-title" class="form-control" value="{{ prefill.title|default:'' }}">

    <label for="author">Author(s)</label>
    <input type="text" name="author" id="book-authors" class="form-control" value="{{ prefill.author|default:'' }}">

    <label for="description">Description</label>
    <textarea name="description" id="book-description" class="form-control">{{ prefill.description|default:'' }}</textarea>

    <label for="cover">Cover Image URL</label>
    <input type="url" name="cover_url" id="book-cover-url" class="form-control" value="{{ prefill.cover_url|default:'' }}">

    <div></div></li><label for="pages">Page Count</label>
    <input type="number" name="pages" id="book-pages" class="form-control"
           min="0" step="1" value="{{ prefill.pages|default:'' }}">
    <small class="form-text text-muted mb-2">
      Page count is taken from Google Books API, your edition may vary. You can adjust manually in admin settings.
    </small></div>

    <div></div></li><label for="words">Word Count</label>
    <input type="number" name="words" id="book-words" class="form-control"
           min="0" step="1" value="{{ prefill.words|default:'' }}">
    <small class="form-text text-muted mb-2">
      Word count is estimated from number of pages. You can adjust it manually.
    </small></div>

    <div><label for="category">Book Category</label>
    <select name="book_category" id="book-category-select" class="form-control">
      <option value="">-- Select Category --</option>
      {% for cat in categories %}
        <option value="{{ cat.id }}" {% if prefill.book_category == cat.id|stringformat:"s" %}selected{% endif %}>{{ cat.name }}</option>
      {% endfor %}
      <option value="new" {% if prefill.book_category == "new" %}selected{% endif %}>Other / Create New</option>
    </select>
    </div>

    <div id="new-category-input" class="mt-2" style="display: {% if prefill.book_category == "new" %}block{% else %}none{% endif %};">
      <label for="new_category_name">New Category Name</label>
      <input type="text" name="new_category_name" class="form-control" value="{{ prefill.new_category_name|default:'' }}">
    </div>

      <div><label for="series">Book Series</label>
        <select name="series_name" id="book-series-select" class="form-control">
          <option value="">-- Select series --</option>
          {% for series in series %}
            <option value="{{ series.id }}" {% if prefill.series_name == series.id|stringformat:"s" %}selected{% endif %}>{{ series.series_name }}</option>
          {% endfor %}
          <option value="new" {% if prefill.series_name == "new" %}selected{% endif %}>Other / Create New</option>
        </select>
        </div>

        <div id="new-series-input" class="mt-2" style="display: {% if prefill.series_name == "new" %}block{% else %}none{% endif %};">
          <label for="new_series_name">New series Name</label>
          <input type="text" name="new_series_name" class="form-control" value="{{ prefill.new_series_name|default:'' }}">
        </div>

    <img id="book-cover-preview" src="{{ prefill.cover_url|default:'' }}" class="img-fluid mt-3 mb-3" style="display: {% if prefill.cover_url %}block{% else %}none{% endif %}; max-height: 250px;" />

    <button type="submit" class="btn btn-success mt-3">Confirm and Add Book</button>
  </form>

  <script>
    document.getElementById("book-category-select").addEventListener("change", function () {
      const newCat = document.getElementById("new-category-input");
      newCat.style.display = this.value === "new" ? "block" : "none";
    });

    document.getElementById("book-series-select").addEventListener("change", function () {
      const newCat = document.getElementById("new-series-input");
      newCat.style.display = this.value === "new" ? "block" : "none";
    });

    document.getElementById('search-form').addEventListener('submit', async function (e) {
      e.preventDefault();
      const query = document.getElementById('book-title-search').value;
      const errorDiv = document.getElementById('search-error');
      const form = document.getElementById('add-book-form');

      try {
        const response = await fetch(`/book_club/api/fetch_book_data/?q=${encodeURIComponent(query)}`);
        const data = await response.json();

        if (data && data.title) {
          document.getElementById('book-title').value = data.title;
          document.getElementById('book-authors').value = data.authors.join(', ');
          document.getElementById('book-description').value = data.description || '';
          document.getElementById('book-cover-url').value = data.thumbnail_url || '';
          document.getElementById('book-words').value = data.estimated_words || '';
          document.getElementById('book-source').value = data.source || '';
          document.getElementById('book-pages').value = data.pages || '';

          if (data.thumbnail_url) {
            const preview = document.getElementById('book-cover-preview');
            preview.src = data.thumbnail_url;
            preview.style.display = 'block';
          }

          errorDiv.style.display = 'none';
          form.style.display = 'block';
        } else {
          throw new Error('Book not found.');
        }
      } catch (err) {
        errorDiv.textContent = err.message;
        errorDiv.style.display = 'block';
        form.style.display = 'none';
      }
    });
  </script>
{% endblock %}

